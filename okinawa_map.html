<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>沖縄戦場所マップ（積算表示）</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 40px; bottom: 0; width: 100%; }
        #filter {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            background: white;
            padding: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div id="filter">
    月を選択：
    <select id="monthSelect">
        <option value="7月以降">7月以降</option>
        <option value="6月">6月</option>
        <option value="5月">5月</option>
        <option value="4月">4月</option>
        <option value="3月">3月</option>
    </select>
</div>
<div id="map"></div>
<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibmthbWltdXJhIiwiYSI6ImNtYmttZmFtaDBybzIyanB5YnJtd2d1bzUifQ.qE8Mw9_IdFq5ZMyM9SLKww';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [127.8, 26.4],
        zoom: 8.2,
        pitch: 60,
        bearing: -17.6,
        antialias: true
    });

    const sourceIds = [];  // 現在表示中のsource IDを記録

    const monthToUrls = {
        "3月": [
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_3.geojson"
        ],
        "4月": [
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_3.geojson",
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_4.geojson"
        ],
        "5月": [
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_3.geojson",
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_4.geojson",
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_5.geojson"
        ],
        "6月": [
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_3.geojson",
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_4.geojson",
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_5.geojson",
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_6.geojson"
        ],
        "7月以降": [
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_3.geojson",
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_4.geojson",
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_5.geojson",
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_6.geojson",
            "https://k-naritoshi.github.io/okinawa-war-map/okinawa_war_deaths_monthly_7.geojson"
        ]
    };

    function clearSourcesAndLayers() {
        for (const id of sourceIds) {
            if (map.getLayer(id)) map.removeLayer(id);
            if (map.getSource(id)) map.removeSource(id);
        }
        sourceIds.length = 0;
    }

    function loadGeoJsonCumulative(month) {
        clearSourcesAndLayers();
        const urls = monthToUrls[month];
        urls.forEach((url, idx) => {
            const sourceId = `source-${idx}`;
            const layerId = `layer-${idx}`;
            sourceIds.push(sourceId);
            map.addSource(sourceId, {
                type: 'geojson',
                data: url
            });
            map.addLayer({
                id: layerId,
                type: 'circle',
                source: sourceId,
                paint: {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['get', '合計戦死者数'],
                        0, 1,
                        3000, 20,
                        6000, 30
                    ],
                    'circle-color': '#e55e5e',
                    'circle-opacity': 0.7
                }
            });

            map.on('click', layerId, (e) => {
                const props = e.features[0].properties;
                new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(`<strong>${props.住所}</strong><br>戦死者数: ${props.合計戦死者数}人`)
                    .addTo(map);
            });

            map.on('mouseenter', layerId, () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', layerId, () => {
                map.getCanvas().style.cursor = '';
            });
        });
    }

    map.on('load', () => {
        loadGeoJsonCumulative("7月以降");  // 初期表示：すべて表示
        document.getElementById("monthSelect").addEventListener("change", (e) => {
            const selectedMonth = e.target.value;
            loadGeoJsonCumulative(selectedMonth);
        });
    });
</script>
</body>
</html>
